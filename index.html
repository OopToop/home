<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OopToop - Home</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

<style>
body { background:#fff; color:#0f0f0f; }
.video-card:hover .video-thumb { border-radius:0; transition:.2s }
.no-scrollbar::-webkit-scrollbar { display:none }
.no-scrollbar { scrollbar-width:none }
</style>
</head>

<body class="font-sans antialiased">

<!-- NAV -->
 <!-- Top Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 h-14 bg-white flex items-center justify-between px-4 z-50 border-b border-gray-100">
        <div class="flex items-center gap-4">
            <button class="p-2 hover:bg-gray-100 rounded-full">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <a href="index.html" class="flex items-center gap-1 group">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/OopToop/home/main/logo.png" 
                         alt="OopToop Logo" 
                         class="h-8 w-auto mr-1"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="hidden bg-red-600 rounded-lg p-1 group-hover:bg-red-700 transition-colors">
                        <i data-lucide="play" class="w-5 h-5 text-white fill-current"></i>
                    </div>
                </div>
                <span class="text-xl font-bold tracking-tighter">OopToop</span>
            </a>
        </div>

  <input id="search-input" placeholder="Search" class="hidden md:block border rounded px-3 py-1">

  <div id="auth-section" class="flex gap-2">
    <div id="user-profile" class="hidden w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white"></div>
    <button id="signout-btn" class="hidden border px-3 py-1 text-red-600 rounded">Sign out</button>
    <button id="signin-btn" class="border px-3 py-1 text-blue-600 rounded">Sign in</button>
    <button id="register-btn" class="border px-3 py-1 text-green-600 rounded">Register</button>
  </div>
</nav>

<!-- CONTENT -->
<main class="pt-16 px-6">

  <!-- TAGS -->
  <div id="tags-bar" class="flex gap-2 mb-6">
    <button class="tag-btn bg-black text-white px-3 py-1 rounded" data-tag="All">All</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded" data-tag="Music">Music</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded" data-tag="Gaming">Gaming</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded" data-tag="Tech">Tech</button>
  </div>

  <!-- VIDEO GRID -->
  <div id="video-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

</main>

<script>
lucide.createIcons();

/* ---------- AUTH (GUN) ---------- */
const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
const user = gun.user().recall({ sessionStorage:true });

const ui = {
  profile: document.getElementById('user-profile'),
  signin: document.getElementById('signin-btn'),
  register: document.getElementById('register-btn'),
  signout: document.getElementById('signout-btn')
};

function updateAuth() {
  if (user.is) {
    ui.profile.classList.remove('hidden');
    ui.signout.classList.remove('hidden');
    ui.signin.classList.add('hidden');
    ui.register.classList.add('hidden');
    user.get('alias').once(a => ui.profile.textContent = a?.[0]?.toUpperCase() || '?');
  } else {
    ui.profile.classList.add('hidden');
    ui.signout.classList.add('hidden');
    ui.signin.classList.remove('hidden');
    ui.register.classList.remove('hidden');
  }
}

updateAuth();

ui.signin.onclick = () => {
  const u = prompt('Username');
  const p = prompt('Password');
  user.auth(u,p,ack=>ack.err?alert(ack.err):updateAuth());
};

ui.register.onclick = () => {
  const u = prompt('Username');
  const p = prompt('Password');
  user.create(u,p,ack=>ack.err?alert(ack.err):alert('Account created'));
};

ui.signout.onclick = () => { user.leave(); updateAuth(); };

/* ---------- VIDEOS ---------- */
const feed = document.getElementById('video-feed');
let allVideos = [];

fetch('https://api.github.com/repos/OopToop/videos/contents/metadata')
  .then(r=>r.json())
  .then(files=>Promise.all(
    files.filter(f=>f.name.endsWith('.json'))
         .map(f=>fetch(f.download_url).then(r=>r.json()).then(d=>({file:f.name,data:d})))
  ))
  .then(videos=>{
    allVideos = videos;
    render(videos);
  });

function render(list){
  feed.innerHTML='';
  list.forEach(v=>{
    const c=document.createElement('div');
    c.className='video-card cursor-pointer';
    c.innerHTML=`
      <img class="video-thumb rounded-xl mb-2" src="https://raw.githubusercontent.com/OopToop/videos/main/thumbnails/${v.data.thumbnail}">
      <h3 class="font-semibold">${v.data.title}</h3>
    `;
    c.onclick=()=>location.href=`video.html?id=${encodeURIComponent(v.file)}`;
    feed.appendChild(c);
  });
}

document.getElementById('search-input').oninput=e=>{
  const q=e.target.value.toLowerCase();
  render(allVideos.filter(v=>v.data.title?.toLowerCase().includes(q)));
};
</script>

</body>
</html>
