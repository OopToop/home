<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OopToop - Home</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="favicon.png" type="image/png">
<link rel="apple-touch-icon" href="favicon.png">


<style>
body { background:#fff; color:#0f0f0f; }
.video-card:hover .video-thumb { border-radius:0; transition:.2s }
.no-scrollbar::-webkit-scrollbar { display:none }
.no-scrollbar { scrollbar-width:none }
</style>
</head>

<body class="font-sans antialiased">

<!-- NAV -->
    <nav class="fixed top-0 left-0 right-0 h-14 bg-white flex items-center justify-between px-4 z-50 border-b border-gray-100">
        <div class="flex items-center gap-4">
            <button class="p-2 hover:bg-gray-100 rounded-full" onclick="location.href='https://ooptoop.github.io/home/leaderboard.html'">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <a href="index.html" class="flex items-center gap-1 group">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/OopToop/home/main/logo.png" 
                         alt="OopToop Logo" 
                         class="h-8 w-auto mr-1"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="hidden bg-red-600 rounded-lg p-1 group-hover:bg-red-700 transition-colors">
                        <i data-lucide="play" class="w-5 h-5 text-white fill-current"></i>
                    </div>
                </div>
                <span class="text-xl font-bold tracking-tighter">OopToop</span>
            </a>
        </div>

  <input id="search-input" placeholder="Search" class="hidden md:block border rounded-full px-4 py-1.5 w-full max-w-md bg-gray-50 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all">

  <div id="action-section" class="flex gap-3 items-center">
    <a href="https://docs.google.com/forms/d/e/1FAIpQLScyEZsuGbtWar5SkQlbXofYXDHlHcOgLLJNz-_CyZUBO3hUgg/viewform" 
       target="_blank" 
       class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 px-4 py-1.5 rounded-full text-sm font-medium transition-colors">
        <i data-lucide="video" class="w-5 h-5"></i>
        <span class="hidden sm:inline">Upload</span>
    </a>
  </div>
</nav>

<!-- CONTENT -->
<main class="pt-16 px-6">

  <!-- TAGS -->
  <div id="tags-bar" class="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-2">
    <button class="tag-btn bg-black text-white px-3 py-1 rounded whitespace-nowrap" data-tag="All">All</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded whitespace-nowrap" data-tag="Music">Music</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded whitespace-nowrap" data-tag="Gaming">Gaming</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded whitespace-nowrap" data-tag="Tech">Tech</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded whitespace-nowrap" data-tag="Real Life">Real Life</button>
    <button class="tag-btn bg-gray-100 px-3 py-1 rounded whitespace-nowrap" data-tag="Animation">Animation</button>
  </div>

  <!-- VIDEO GRID -->
  <div id="video-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

</main>

<script>
lucide.createIcons();

const feed = document.getElementById('video-feed');
let allVideos = [];
let leaderboardData = {};

const tagGroups = {
  "Music": ["music", "song", "audio", "musical", "singer", "concert"],
  "Gaming": ["gaming", "games", "gameplay", "play", "walkthrough", "speedrun"],
  "Tech": ["tech", "technology", "hardware", "coding", "programming", "review", "unboxing"],
  "Real Life": ["reallife", "life", "live"],
  "Animation": ["animation", "animated"]
};

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// Initial data fetch
fetch('https://raw.githubusercontent.com/OopToop/videos/main/leaderboard.json')
  .then(r => r.json())
  .then(data => {
    leaderboardData = data;
    return fetch('https://api.github.com/repos/OopToop/videos/contents/metadata');
  })
  .then(r => r.json())
  .then(files => {
    // Ensure we ONLY try to fetch .json files from the metadata folder
    const metadataFiles = files.filter(f => f.name.toLowerCase().endsWith('.json'));
    
    return Promise.all(
      metadataFiles.map(f => 
        fetch(f.download_url)
          .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
          })
          .then(d => ({file: f.name, data: d}))
          .catch(err => {
            console.warn(`Skipping invalid metadata file: ${f.name}`, err);
            return null; // Return null so we can filter it out
          })
      )
    );
  })
  .then(videos => {
    // Filter out any files that failed to parse (returned null)
    allVideos = shuffleArray(videos.filter(v => v !== null));
    render(allVideos);
  })
  .catch(err => console.error("Error loading OopToop data:", err));

function render(list){
  feed.innerHTML = '';
  list.forEach(v => {
    const author = v.data.author || v.data.uploader || 'OopToop Creator';
    const views = v.data.views !== undefined ? parseInt(v.data.views).toLocaleString() : "0";
    const pfpUrl = `https://raw.githubusercontent.com/OopToop/videos/main/profile%20pictures/${encodeURIComponent(author)}.jpg`;

    const c = document.createElement('div');
    c.className = 'video-card cursor-pointer group';
    
    c.innerHTML = `
      <img class="video-thumb rounded-xl mb-3 w-full aspect-video object-cover bg-gray-100" 
           src="https://raw.githubusercontent.com/OopToop/videos/main/thumbnails/${v.data.thumbnail}">
      <div class="flex gap-3">
        <div class="w-9 h-9 shrink-0 relative">
          <img src="${pfpUrl}" class="w-9 h-9 rounded-full object-cover hidden" onload="this.classList.remove('hidden'); this.nextElementSibling.classList.add('hidden')">
          <div class="w-9 h-9 rounded-full bg-purple-600 flex items-center justify-center text-white text-xs font-bold uppercase">${author.charAt(0)}</div>
        </div>
        <div class="flex flex-col">
          <h3 class="font-semibold line-clamp-2 leading-snug">${v.data.title}</h3>
          <p class="text-sm text-gray-600 mt-1">${author}</p>
          <p class="text-xs text-gray-500">${views} views</p>
        </div>
      </div>
    `;

    // Navigation logic with ID passing
    c.onclick = () => {
      location.href = `video.html?id=${encodeURIComponent(v.file)}`;
    };

    feed.appendChild(c);
  });
}

// Search input logic
document.getElementById('search-input').oninput = e => {
  const q = e.target.value.toLowerCase();
  render(allVideos.filter(v => v.data.title?.toLowerCase().includes(q)));
};

// Genre button logic
document.getElementById('tags-bar').onclick = e => {
  const btn = e.target.closest('.tag-btn');
  if (!btn) return;

  const category = btn.dataset.tag;

  document.querySelectorAll('.tag-btn').forEach(b => {
    b.classList.remove('bg-black', 'text-white');
    b.classList.add('bg-gray-100', 'text-black');
  });
  btn.classList.add('bg-black', 'text-white');
  btn.classList.remove('bg-gray-100', 'text-black');

  if (category === 'All') {
    render(allVideos);
  } else {
    const keywords = tagGroups[category] || [category.toLowerCase()];
    const filtered = allVideos.filter(v => {
      const vTags = ((v.data.tags || "") + " " + (v.data.category || "")).toLowerCase();
      return keywords.some(k => vTags.includes(k));
    });
    render(filtered);
  }
};
</script>

</body>
</html>
