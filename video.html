<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OopToop - Watch</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Lucide -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Gun -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

<style>
body {
    background-color: #ffffff;
    color: #0f0f0f;
}
.star {
    cursor: pointer;
    transition: transform 0.1s ease;
}
.star:hover {
    transform: scale(1.1);
}
.star.selected svg {
    fill: #fbbf24;
    color: #fbbf24;
}
video {
    background-color: black;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}
</style>
</head>

<body class="font-sans antialiased">

<!-- NAV -->
<nav class="fixed top-0 left-0 right-0 h-14 bg-white flex items-center justify-between px-4 z-50 border-b border-gray-100">
    <div class="flex items-center gap-4">
        <a href="index.html" class="flex items-center gap-1">
            <img src="https://raw.githubusercontent.com/OopToop/home/main/logo.png" class="h-8">
            <span class="text-xl font-bold tracking-tighter">OopToop</span>
        </a>
    </div>

    <input id="search-input" placeholder="Search" class="hidden md:block border rounded px-3 py-1">

    <div class="flex gap-2">
        <div id="user-profile" class="hidden w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white"></div>
        <button id="signout-btn" class="hidden border px-3 py-1 text-red-600 rounded">Sign out</button>
        <button id="signin-btn" class="border px-3 py-1 text-blue-600 rounded">Sign in</button>
        <button id="register-btn" class="border px-3 py-1 text-green-600 rounded">Register</button>
    </div>
</nav>

<!-- MAIN -->
<main class="pt-20 px-4 max-w-[1400px] mx-auto pb-10">
<div class="flex flex-col lg:flex-row gap-6">

<!-- LEFT -->
<div class="flex-1">
    <div class="rounded-xl overflow-hidden aspect-video bg-black">
        <video id="video-player" class="w-full h-full" controls autoplay></video>
    </div>

    <h1 id="video-title" class="mt-4 text-xl font-bold">Loading…</h1>

    <div class="mt-2 text-sm text-gray-600">
        <span id="video-views">0</span> views • <span id="video-date">—</span>
    </div>

    <p id="video-description" class="mt-3 bg-gray-100 rounded-xl p-3 text-sm"></p>

    <!-- Stars -->
    <div class="mt-4 flex gap-1" id="star-rating">
        <span class="star" data-value="1"><i data-lucide="star"></i></span>
        <span class="star" data-value="2"><i data-lucide="star"></i></span>
        <span class="star" data-value="3"><i data-lucide="star"></i></span>
        <span class="star" data-value="4"><i data-lucide="star"></i></span>
        <span class="star" data-value="5"><i data-lucide="star"></i></span>
    </div>
</div>

</div>
</main>

<script>
lucide.createIcons();

/* ================= AUTH ================= */
const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
const user = gun.user().recall({ sessionStorage: true });

const ui = {
    profile: document.getElementById('user-profile'),
    signin: document.getElementById('signin-btn'),
    register: document.getElementById('register-btn'),
    signout: document.getElementById('signout-btn')
};

function updateAuth() {
    if (user.is) {
        ui.profile.classList.remove('hidden');
        ui.signout.classList.remove('hidden');
        ui.signin.classList.add('hidden');
        ui.register.classList.add('hidden');
        user.get('alias').once(a => ui.profile.textContent = a?.[0]?.toUpperCase() || '?');
    } else {
        ui.profile.classList.add('hidden');
        ui.signout.classList.add('hidden');
        ui.signin.classList.remove('hidden');
        ui.register.classList.remove('hidden');
    }
}
updateAuth();

ui.signin.onclick = () => {
    const u = prompt('Username');
    const p = prompt('Password');
    user.auth(u, p, ack => ack.err ? alert(ack.err) : updateAuth());
};
ui.register.onclick = () => {
    const u = prompt('Username');
    const p = prompt('Password');
    user.create(u, p, ack => ack.err ? alert(ack.err) : alert('Account created'));
};
ui.signout.onclick = () => { user.leave(); updateAuth(); };

/* ================= VIDEO + GLOBAL VIEWS ================= */
const owner = 'OopToop';
const repo = 'videos';
const videoBase = `https://raw.githubusercontent.com/${owner}/${repo}/main/videos/`;
const metadataBase = `https://raw.githubusercontent.com/${owner}/${repo}/main/metadata/`;

const videosDB = gun.get('videos');

const params = new URLSearchParams(window.location.search);
const videoFile = params.get('id');

if (videoFile) {
    fetch(metadataBase + videoFile)
        .then(r => r.json())
        .then(data => {
            // Video info
            document.getElementById('video-title').textContent = data.title;
            document.getElementById('video-description').textContent = data.description || '';
            document.getElementById('video-date').textContent = data.date || 'Unknown';

            const player = document.getElementById('video-player');
            player.src = videoBase + encodeURIComponent(data.filename);

            // GLOBAL VIEW COUNTER
            const videoNode = videosDB.get(videoFile);
            const viewsEl = document.getElementById('video-views');

            // Subscribe to live updates
            videoNode.get('views').on(v => {
            viewsEl.textContent = (v || 0).toLocaleString();
            });

            // Increment view count
            videoNode.get('views').once(current => {
                const newVal = (parseInt(current) || 0) + 1;
                videoNode.get('views').put(newVal);
            });


            // STARS (local only)
            const stars = document.querySelectorAll('.star');
            const ratingKey = `rating-${videoFile}`;
            const saved = localStorage.getItem(ratingKey) || 0;

            function updateStars(val) {
                stars.forEach(s => s.classList.toggle('selected', s.dataset.value <= val));
            }
            updateStars(saved);

            stars.forEach(s => {
                s.onclick = () => {
                    localStorage.setItem(ratingKey, s.dataset.value);
                    updateStars(s.dataset.value);
                };
            });
        })
        .catch(err => {
            document.getElementById('video-title').textContent = "Error loading video";
        });
}
</script>


</body>
</html>

