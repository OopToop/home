<script>
lucide.createIcons();

/* ---------- AUTH (GUN) - FIXED & MULTI-DEVICE ---------- */

const gun = Gun({
  peers: ['https://gun-manhattan.herokuapp.com/gun'],
  localStorage: true
});

const user = gun.user(); // â— NO recall here

const ui = {
  profile: document.getElementById('user-profile'),
  signin: document.getElementById('signin-btn'),
  register: document.getElementById('register-btn'),
  signout: document.getElementById('signout-btn')
};

function updateAuth() {
  if (user.is) {
    ui.profile.classList.remove('hidden');
    ui.signout.classList.remove('hidden');
    ui.signin.classList.add('hidden');
    ui.register.classList.add('hidden');

    const alias = user.is.alias || '?';
    ui.profile.textContent = alias[0].toUpperCase();
  } else {
    ui.profile.classList.add('hidden');
    ui.signout.classList.add('hidden');
    ui.signin.classList.remove('hidden');
    ui.register.classList.remove('hidden');
  }
}

// Restore session if exists
gun.on('auth', () => updateAuth());

updateAuth();

/* ---------- SIGN IN ---------- */
ui.signin.onclick = () => {
  let u = prompt('Username');
  let p = prompt('Password');

  if (!u || !p) return alert('Missing fields');

  u = u.trim().toLowerCase(); // normalize

  user.auth(u, p, ack => {
    if (ack.err) {
      alert('Invalid username or password');
    } else {
      updateAuth();
    }
  });
};

/* ---------- REGISTER ---------- */
ui.register.onclick = () => {
  let u = prompt('Choose a username');
  let p = prompt('Choose a password');

  if (!u || !p) return alert('Missing fields');

  u = u.trim().toLowerCase(); // normalize

  user.create(u, p, ack => {
    if (ack.err) {
      alert(ack.err); // Gun will say if name exists
    } else {
      alert('Account created! You can now sign in.');
    }
  });
};

/* ---------- SIGN OUT ---------- */
ui.signout.onclick = () => {
  user.leave();
  updateAuth();
};
</script>
