<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OopToop - Watch</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #ffffff;
            color: #0f0f0f;
        }
        .star {
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .star:hover {
            transform: scale(1.1);
        }
        .star.selected svg {
            fill: #fbbf24;
            color: #fbbf24;
        }
        video {
            background-color: black;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        /* Notification styling */
        #copy-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #0f0f0f;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }
        #copy-toast.show {
            opacity: 1;
        }
    </style>
</head>
<body class="font-sans antialiased">

    <!-- Copy Link Notification -->
    <div id="copy-toast">Link Copied!</div>

    <!-- NAV -->
    <!-- Top Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 h-14 bg-white flex items-center justify-between px-4 z-50 border-b border-gray-100">
        <div class="flex items-center gap-4">
            <!-- Updated Leaderboard Button Link to External URL -->
            <button class="p-2 hover:bg-gray-100 rounded-full" onclick="location.href='https://ooptoop.github.io/home/leaderboard.html'">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <a href="index.html" class="flex items-center gap-1 group">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/OopToop/home/main/logo.png" 
                         alt="OopToop Logo" 
                         class="h-8 w-auto mr-1"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="hidden bg-red-600 rounded-lg p-1 group-hover:bg-red-700 transition-colors">
                        <i data-lucide="play" class="w-5 h-5 text-white fill-current"></i>
                    </div>
                </div>
                <span class="text-xl font-bold tracking-tighter">OopToop</span>
            </a>
        </div>

        <input id="search-input" placeholder="Search" class="hidden md:block border rounded-full px-4 py-1.5 w-full max-w-md bg-gray-50 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all">

        <div id="action-section" class="flex gap-3 items-center">
            <!-- Upload Button -->
            <a href="https://docs.google.com/forms/d/e/1FAIpQLScyEZsuGbtWar5SkQlbXofYXDHlHcOgLLJNz-_CyZUBO3hUgg/viewform" 
               target="_blank" 
               class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 px-4 py-1.5 rounded-full text-sm font-medium transition-colors">
                <i data-lucide="video" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Upload</span>
            </a>
        </div>
    </nav>

    <!-- Main Player Layout -->
    <main class="pt-20 px-4 md:px-8 lg:px-16 max-w-[1600px] mx-auto pb-10">
        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- Left Side: Video Player and Metadata -->
            <div class="flex-1">
                <div class="rounded-xl overflow-hidden aspect-video w-full bg-black">
                    <video id="video-player" class="w-full h-full" controls autoplay></video>
                </div>

                <div class="mt-4">
                    <h1 id="video-title" class="text-xl font-bold line-clamp-2">Loading...</h1>
                    
                    <div class="mt-3 flex flex-wrap items-center justify-between gap-4">
                        <!-- Author Info -->
                        <div class="flex items-center gap-3">
                            <!-- Dynamic Channel Profile Picture -->
                            <div class="relative w-10 h-10 shrink-0">
                                <img id="channel-pfp" src="" alt="" class="w-10 h-10 rounded-full bg-gray-200 object-cover hidden">
                                <div id="pfp-fallback" class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold uppercase">?</div>
                            </div>
                            <div>
                                <p id="uploader-name" class="font-semibold text-base leading-none">OopToop Creator</p>
                                <p id="sub-count" class="text-sm text-gray-500 mt-1">-- subscribers</p>
                            </div>
                            <button class="ml-4 bg-black text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-800 transition-colors">Subscribe</button>
                        </div>

                        <!-- Actions Bar (Ratings) -->
                        <div class="flex items-center bg-gray-100 rounded-full px-4 py-2 gap-4">
                            <div id="star-rating" class="flex items-center border-r border-gray-300 pr-4">
                                <span class="star p-1" data-value="1"><i data-lucide="star" class="w-5 h-5"></i></span>
                                <span class="star p-1" data-value="2"><i data-lucide="star" class="w-5 h-5"></i></span>
                                <span class="star p-1" data-value="3"><i data-lucide="star" class="w-5 h-5"></i></span>
                                <span class="star p-1" data-value="4"><i data-lucide="star" class="w-5 h-5"></i></span>
                                <span class="star p-1" data-value="5"><i data-lucide="star" class="w-5 h-5"></i></span>
                            </div>
                            <button id="share-btn" class="flex items-center gap-2 hover:bg-gray-200 rounded-full transition-colors px-2 py-1">
                                <i data-lucide="share-2" class="w-5 h-5"></i>
                                <span class="text-sm font-medium">Share</span>
                            </button>
                        </div>
                    </div>

                    <!-- Description Box -->
                    <div class="mt-4 bg-gray-100 rounded-xl p-3 text-sm hover:bg-gray-200 transition-colors cursor-pointer">
                        <div class="font-bold mb-1">
                            <span id="video-views">0</span> views â€¢ <span id="video-date">Recently</span>
                        </div>
                        <p id="video-description" class="whitespace-pre-wrap text-gray-800"></p>
                    </div>
                </div>
            </div>

            <!-- Right Side: Sidebar/Up Next -->
            <div class="lg:w-[350px] xl:w-[400px]">
                <h2 class="font-bold mb-4">Up next</h2>
                <div id="sidebar-feed" class="flex flex-col gap-4">
                    <p class="text-gray-400 text-sm italic">Loading related videos...</p>
                </div>
            </div>

        </div>
    </main>

<script>
    lucide.createIcons();

    // --- VIDEO LOADING LOGIC ---
    const owner = 'OopToop';
    const repo = 'videos';
    const videoBase = `https://raw.githubusercontent.com/${owner}/${repo}/main/videos/`;
    const metadataBase = `https://raw.githubusercontent.com/${owner}/${repo}/main/metadata/`;
    const pfpBase = `https://raw.githubusercontent.com/OopToop/videos/main/profile%20pictures/`;

    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    const videoFile = getQueryParam('id');

    if (videoFile) {
        // Fetch Metadata and Leaderboard
        Promise.all([
            fetch(metadataBase + videoFile).then(res => res.json()),
            fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/leaderboard.json`).then(res => res.json())
        ])
        .then(([data, leaderboard]) => {
            document.getElementById('video-title').textContent = data.title;
            document.getElementById('video-description').textContent = data.description || "No description.";
            document.getElementById('video-date').textContent = data.date || "Unknown date";
            
            const uploader = data.author || data.uploader || 'OopToop Creator';
            document.getElementById('uploader-name').textContent = uploader;
            
            // Sub count from leaderboard
            const subs = leaderboard[uploader];
            document.getElementById('sub-count').textContent = subs !== undefined 
                ? `${subs.toLocaleString()} subscribers` 
                : "1.2M subscribers";

            // Profile Picture Logic
            const pfpImg = document.getElementById('channel-pfp');
            const fallback = document.getElementById('pfp-fallback');
            const pfpUrl = `${pfpBase}${encodeURIComponent(uploader)}.jpg`;

            pfpImg.onload = () => {
                pfpImg.classList.remove('hidden');
                fallback.classList.add('hidden');
            };
            pfpImg.onerror = () => {
                pfpImg.classList.add('hidden');
                fallback.classList.remove('hidden');
                fallback.textContent = uploader.charAt(0).toUpperCase();
            };
            pfpImg.src = pfpUrl;

            // VIEW COUNT LOGIC: Rip directly from metadata file instead of using Local Storage
            const viewsEl = document.getElementById('video-views');
            const rawViews = data.views || 0;
            viewsEl.textContent = parseInt(rawViews).toLocaleString();

            const player = document.getElementById('video-player');
            player.src = videoBase + encodeURIComponent(data.filename);

            // Stars logic
            const stars = document.querySelectorAll('.star');
            let ratingKey = `rating-${videoFile}`;
            let savedRating = localStorage.getItem(ratingKey) || 0;

            const updateStars = (val) => {
                stars.forEach(s => {
                    if (parseInt(s.dataset.value) <= val) s.classList.add('selected');
                    else s.classList.remove('selected');
                });
            };
            updateStars(savedRating);

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const val = star.dataset.value;
                    localStorage.setItem(ratingKey, val);
                    updateStars(val);
                });
            });
        })
        .catch(err => {
            document.getElementById('video-title').textContent = "Error loading video";
        });
    }

    // --- SHARE LOGIC ---
    const shareBtn = document.getElementById('share-btn');
    const toast = document.getElementById('copy-toast');

    shareBtn.addEventListener('click', () => {
        const url = window.location.href;
        
        // Use standard clipboard copy fallback for iFrame environments
        const el = document.createElement('textarea');
        el.value = url;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);

        // Show Toast
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    });

    // --- SEARCH REDIRECT ---
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            window.location.href = `index.html?q=${encodeURIComponent(e.target.value)}`;
        }
    });
</script>

</body>
</html>
