<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OopToop - Channel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">
    <style>
        body { background-color: #ffffff; color: #0f0f0f; }
        .tab-active { border-bottom: 2px solid #0f0f0f; font-weight: 600; }
    </style>
</head>
<body class="font-sans antialiased">

    <!-- NAV -->
    <nav class="fixed top-0 left-0 right-0 h-14 bg-white flex items-center justify-between px-4 z-50 border-b border-gray-100">
        <div class="flex items-center gap-4">
            <button class="p-2 hover:bg-gray-100 rounded-full" onclick="location.href='https://ooptoop.github.io/home/leaderboard.html'">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <a href="index.html" class="flex items-center gap-1">
                <img src="https://raw.githubusercontent.com/OopToop/home/main/logo.png" alt="OopToop" class="h-8 w-auto mr-1">
                <span class="text-xl font-bold tracking-tighter">OopToop</span>
            </a>
        </div>
        <input id="search-input" placeholder="Search" class="hidden md:block border rounded-full px-4 py-1.5 w-full max-w-md bg-gray-50 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all">
        <div class="flex gap-3 items-center">
            <a href="https://docs.google.com/forms/d/e/1FAIpQLScyEZsuGbtWar5SkQlbXofYXDHlHcOgLLJNz-_CyZUBO3hUgg/viewform" target="_blank" class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 px-4 py-1.5 rounded-full text-sm font-medium">
                <i data-lucide="video" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Upload</span>
            </a>
        </div>
    </nav>

    <!-- Channel Header -->
    <header class="pt-20 px-4 md:px-8 lg:px-16 max-w-[1400px] mx-auto">
        <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
            <!-- PFP -->
            <div class="w-32 h-32 md:w-40 md:h-40 shrink-0 relative">
                <img id="channel-pfp" src="" alt="" class="w-full h-full rounded-full bg-gray-100 object-cover hidden">
                <div id="pfp-fallback" class="w-full h-full rounded-full bg-purple-600 flex items-center justify-center text-white text-5xl font-bold uppercase">?</div>
            </div>
            
            <!-- Channel Info -->
            <div class="flex-1 text-center md:text-left">
                <h1 id="channel-name" class="text-3xl font-bold">Loading...</h1>
                <div class="text-gray-500 mt-2 flex flex-col md:flex-row md:items-center gap-1 md:gap-2">
                    <span id="sub-count">-- subscribers</span>
                    <span class="hidden md:inline">•</span>
                    <span id="video-count">-- videos</span>
                </div>
                <div class="mt-4">
                    <button id="subscribe-btn" class="bg-black text-white px-6 py-2 rounded-full font-medium hover:bg-gray-800 transition-all">
                        Subscribe
                    </button>
                </div>
            </div>
        </div>

        <!-- Sorting and Tab -->
        <div class="mt-8 border-b border-gray-100 flex items-center justify-between text-sm">
            <div class="flex gap-6">
                <button class="tab-active px-4 py-3">Videos</button>
            </div>
            <div class="flex items-center gap-2 pb-2">
                <label for="sort-select" class="text-gray-500 font-medium">Sort by:</label>
                <select id="sort-select" class="bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="newest">Newest to Oldest</option>
                    <option value="oldest">Oldest to Newest</option>
                    <option value="popular">Most Popular First</option>
                </select>
            </div>
        </div>
    </header>

    <!-- Content Grid -->
    <main class="px-4 md:px-8 lg:px-16 max-w-[1400px] mx-auto py-8">
        <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Populated by JS -->
        </div>
    </main>

<script>
    lucide.createIcons();

    const owner = 'OopToop';
    const repo = 'videos';
    const metadataBase = `https://raw.githubusercontent.com/${owner}/${repo}/main/metadata/`;
    const pfpBase = `https://raw.githubusercontent.com/OopToop/videos/main/profile%20pictures/`;

    let currentVideos = []; // Store fetched videos globally for easy sorting

    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    const channelName = getQueryParam('c');

    const renderVideos = () => {
        const grid = document.getElementById('video-grid');
        const sortBy = document.getElementById('sort-select').value;
        grid.innerHTML = '';

        // Sorting Logic
        const sorted = [...currentVideos].sort((a, b) => {
            if (sortBy === 'popular') {
                return (b.data.views || 0) - (a.data.views || 0);
            }
            
            // Handle Date sorting
            const dateA = new Date(a.data.date || 0);
            const dateB = new Date(b.data.date || 0);
            
            return sortBy === 'newest' ? dateB - dateA : dateA - dateB;
        });

        sorted.forEach(v => {
            const card = document.createElement('div');
            card.className = 'cursor-pointer group flex flex-col';
            card.onclick = () => location.href = `video.html?id=${v.id}`;
            card.innerHTML = `
                <div class="aspect-video w-full rounded-xl overflow-hidden bg-gray-100 relative">
                    <img src="https://raw.githubusercontent.com/OopToop/videos/main/thumbnails/${v.data.thumbnail}" 
                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                         onerror="this.src='https://via.placeholder.com/400x225?text=No+Thumbnail'">
                </div>
                <div class="mt-3">
                    <h3 class="font-bold text-base line-clamp-2 leading-snug group-hover:text-blue-600 transition-colors">${v.data.title}</h3>
                    <div class="text-sm text-gray-500 mt-1">
                        <span>${(v.data.views || 0).toLocaleString()} views</span>
                        <span>•</span>
                        <span>${v.data.date || 'Recent'}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    };

    if (channelName) {
        document.getElementById('channel-name').textContent = channelName;
        
        const pfpImg = document.getElementById('channel-pfp');
        const fallback = document.getElementById('pfp-fallback');
        pfpImg.onload = () => { pfpImg.classList.remove('hidden'); fallback.classList.add('hidden'); };
        pfpImg.onerror = () => { pfpImg.classList.add('hidden'); fallback.classList.remove('hidden'); fallback.textContent = channelName.charAt(0).toUpperCase(); };
        pfpImg.src = `${pfpBase}${encodeURIComponent(channelName)}.jpg`;

        Promise.all([
            fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/leaderboard.json`).then(res => res.json()),
            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/metadata`).then(res => res.json())
        ])
        .then(async ([leaderboard, allFiles]) => {
            // Subscribe Logic
            const subBtn = document.getElementById('subscribe-btn');
            const subCountEl = document.getElementById('sub-count');
            const serverSubCount = leaderboard[channelName] || 0;
            const subStorageKey = `subscribed-${channelName}`;
            
            let isSubscribed = localStorage.getItem(subStorageKey) === 'true';

            const updateSubUI = () => {
                if (isSubscribed) {
                    subBtn.textContent = 'Subscribed';
                    subBtn.classList.remove('bg-black', 'hover:bg-gray-800');
                    subBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    subCountEl.textContent = `${(serverSubCount + 1).toLocaleString()} subscribers`;
                } else {
                    subBtn.textContent = 'Subscribe';
                    subBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    subBtn.classList.add('bg-black', 'text-white', 'hover:bg-gray-800');
                    subCountEl.textContent = `${serverSubCount.toLocaleString()} subscribers`;
                }
            };

            subBtn.addEventListener('click', () => {
                isSubscribed = !isSubscribed;
                localStorage.setItem(subStorageKey, isSubscribed);
                updateSubUI();
            });

            updateSubUI();

            // Load and Filter Channel Videos
            const metadataFiles = allFiles.filter(f => f.name.endsWith('.json'));
            const metadataPromises = metadataFiles.map(file => fetch(file.download_url).then(r => r.json().then(data => ({id: file.name, data}))).catch(() => null));
            
            currentVideos = (await Promise.all(metadataPromises)).filter(v => v && (v.data.author === channelName || v.data.uploader === channelName));
            
            document.getElementById('video-count').textContent = `${currentVideos.length} videos`;
            
            // Trigger initial render
            renderVideos();

            // Listen for sort changes
            document.getElementById('sort-select').addEventListener('change', renderVideos);
        });
    }

    document.getElementById('search-input').onkeypress = e => {
        if (e.key === 'Enter') location.href = `index.html?q=${encodeURIComponent(e.target.value)}`;
    };
</script>
</body>
</html>
